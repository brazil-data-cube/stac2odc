# Brazil Data Cube (BDC) Engine Example

This page presents the example of the use of `stac2odc` for [Brazil Data Cube](http://brazildatacube.org/pt/pagina-inicial-2/) project use cases. In the context of the BDC, the tool has used in three scenarios: `Online Indexing`, `Download indexing` and `BDC Data Repository indexing`.

The way the tool is used in each of the scenarios is presented below. For each scenario, a mapping engine is defined, each one with its particularities.

**Online indexing**

The first scenario is online indexing. In this scenario, only the URLs of the BDC data are indexed. This scenario allows users outside the infrastructure to consume the data on-demand without downloading the data. It is used through the application of the [bdc_mapper_v09_online.json](engines/bdc_mapper_v09_online.json) mapping engine.

> It is recommended that this approach be applied to test processes and tool development.

**Download indexing**

The second usage scenario is to download data before performing the indexing process. This approach is beneficial for researchers who wish to have their instance of the Open Data Cube with the BDC data already downloaded. With the data downloaded, access and processing can be done quickly. To apply this scenario, you can use the [bdc_mapper_v09_download.json](engines/bdc_mapper_v09_download.json) mapping engine.

> **Note**, depending on the needs, this approach may be time-consuming to apply because it requires data to be downloaded and then indexed.

**BDC Data Repository**

This approach is used internally by the developers and maintainers of the BDC project's Open Data Cube instances. In this approach, data coming from STAC are directly mapped with the BDC data repository. This allows all data generated by the BDC to be indexed without duplicating or downloading the data. The [bdc_mapper_v09_repository.json](engines/bdc_mapper_v09_repository.json) engine defines the process.

> To apply this approach, it is necessary to have direct access to the BDC data repository. This access is internal to the BDC project.

## Usage example

With stac2odc, all the cited approaches can be applied in the same way, varying only the engine's definition file that uses the specificities described. This is one of the advantages of using the tool. Its malleability allows different approaches to be applied during the mapping process.

For an illustrative example, below presents the mapping engine's use that downloads the data before performing the indexing.

> Note that the BDC project needs to use an access key for data consumption. The request for the access key can be made through the [BDC-Portal](https://brazildatacube.dpi.inpe.br/portal/).

**Mapping collection to ODC Product**

Initially, it is necessary to consider the registration of a new Product in the Open Data Cube instance for the indexing of data. To do this operation using stac2odc, it is possible to use the command `collection2product`. Below is an example where you register STAC Collection `LC8_30_16D_STK-1` as an ODC Product.

Note in the command below that the information of the STAC service (`url`) and the mapping engine (`engine-file`) is passed. The access token (`access-token`) is used to access BDC Stac and its products and metadata.

```shell
stac2odc collection2product \
            -c LC8_30_16D_STK-1 \
            --url https://brazildatacube.dpi.inpe.br/stac/ \
            --outdir ./bdc \
            --engine-file examples/brazil-data-cube/engines/bdc_mapper_v09_download.json \
            --access-token My-Token \
            --verbose
```

> Replace `My-Token` to your BDC Access Token

When executing the command, a log will be displayed with the information that the process was initiated.

```
2021-02-05 20:18:54.934 | INFO     | stac2odc.logger:logger_message:20 - start collection2product operation
2021-02-05 20:18:54.960 | INFO     | stac2odc.logger:logger_message:20 - Mapping STAC Collection to ODC Product
2021-02-05 20:18:55.041 | INFO     | stac2odc.logger:logger_message:20 - Adding LC8_30_16D_STK_1
```

After that, the new Product (`LC8_30_16D_STK_1`) has been registered into the Open Data Cube instance. It is possible to check the registration of the new Product using the `datacube product list` command.

```
LC8_30_16D_STK_1  This datacube was generated with all available surface reflectance images from LC8_30 cube. The data is provided with 10 meters of spatial resolution, reprojected and cropped to BDC_MD grid, considering a temporal compositing function of 16 days using the best pixel approach (Stack).
```

**Indexing STAC Assets as ODC Datasets**

Now that the new Product is added, it is possible to index the Datasets. For this purpose, the `item2dataset` command of stac2odc can be used. This command makes use of the same parameters presented previously. The difference is that it will define each Product, and based on the settings made by the engine, it will also download the data files before indexing.

```shell
stac2odc item2dataset \
        --stac-collection LC8_30_16D_STK-1 \
        --dc-product LC8_30_16D_STK_1 \
        --url https://brazildatacube.dpi.inpe.br/stac/ \
        --outdir ./bdc \
        --max-items 3 \
        --engine-file examples/brazil-data-cube/engines/bdc_mapper_v09_download.json \
        --access-token My-Token \
        --verbose
```

With the script's execution, the downloads will be performed, and then the data will be indexed. The output of the script is summarized below

```
2021-02-05 20:19:51.413 | INFO     | stac2odc.logger:logger_message:20 - start item2dataset operation
2021-02-05 20:19:51.413 | INFO     | stac2odc.logger:logger_message:20 - mapping each STAC item in STAC Item Collection
100%|████████████████████████████████████████████████████████████| 163M/163M [00:16<00:00, 9.83MB/s]
100%|████████████████████████████████████████████████████████████| 178M/178M [00:19<00:00, 9.08MB/s]
...
```

It is essential to clarify that the download process defined with the mapping engine being presented is not part of stac2odc. This is an operation specified during the mapping engine creation. It is possible since stac2odc allows arbitrary scripts to be linked to the mapping process.  In the case of [bdc_mapper_v09_download.json](engines/bdc_mapper_v09_download.json) engine, the file that defines the operations is the [bdc_custom_mapping.py](engines/bdc_custom_mapping.py). In this one are present all the download processes executed during the mapping.

It is also worth mentioning that, to use this engine, it is necessary to access the [bdc_custom_mapping.py](engines/bdc_custom_mapping.py) configuration file and change parameters `BDC_EXCLUDED_BANDS`, `BDC_REPOSITORY_PATH`, `BDC_GRID_REFERENCE_BAND` according to the needs and collections being indexed.
